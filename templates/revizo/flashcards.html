{% extends "revizo/base.html" %}
{% load static %}

{% block title %}Flashcards{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'revizo/css/flashcards.css' %}">
<script>
    // Store URLs in global variables
    window.REVIZO_URLS = {
        getTopics: "{% url 'revizo:get_topics' %}",
        filterCards: "{% url 'revizo:filter_flashcards' %}",
        addCard: "{% url 'revizo:add_flashcard' %}"
    };
</script>
{% endblock %}

{% block content %}
<div class="container">
  <h2>All Flashcards</h2>

  <form method="get" id="flashcard-filter-form">
    <div class="filter-controls">
      <div class="form-group">
        <label for="subject">Subject:</label>
        <select id="subject" name="subject" class="form-control">
          <option value="">All Subjects</option>
          {% for subject in subjects %}
          <option value="{{ subject.id }}" {% if subject.id == selected_subject %}selected{% endif %}>
            {{ subject.subject_name }}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="topic">Topic:</label>
        <select id="topic" name="topic" class="form-control">
          <option value="">All Topics</option>
          {% for topic in topics %}
          <option value="{{ topic.id }}" {% if topic.id == selected_topic %}selected{% endif %}>
            {{ topic.topic_name }}
          </option>
          {% endfor %}
        </select>
      </div>
    </div>
  </form>

  <div class="action-buttons">
    <button class="btn btn-success mb-3" data-toggle="modal" data-target="#addCardModal">
      ‚ûï Add New Flashcard
    </button>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered table-hover">
      <thead class="thead-dark">
        <tr>
          <th>Subject</th>
          <th>Topic</th>
          <th>Front</th>
          <th>Back</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for card in flashcards %}
        <tr id="card-{{ card.id }}">
          <td>{{ card.topic.subject.subject_name }}</td>
          <td>{{ card.topic.topic_name }}</td>
          <td contenteditable="true" class="editable" data-field="card_front">
            {{ card.card_front }}
          </td>
          <td contenteditable="true" class="editable" data-field="card_back">
            {{ card.card_back }}
          </td>
          <td>
            <button class="btn btn-primary btn-sm save-card">üíæ Save</button>
            <button class="btn btn-danger btn-sm delete-card">‚ùå Delete</button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="text-center">No flashcards found</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="modal fade" id="addCardModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create New Flashcard</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form id="addCardForm" data-add-url="{% url 'revizo:add_flashcard' %}">
        <div class="modal-body">
          {% csrf_token %}
          <div class="form-group">
            <label>Subject</label>
            <select id="modal-subject" class="form-control" required>
              <option value="">Select Subject</option>
              {% for subject in subjects %}
              <option value="{{ subject.id }}">{{ subject.subject_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label>Topic</label>
            <select name="topic" id="modal-topic" class="form-control" required>
              <option value="">Select Topic</option>
            </select>
          </div>
          <div class="form-group">
            <label>Front Content</label>
            <textarea name="card_front" class="form-control" rows="3" required></textarea>
          </div>
          <div class="form-group">
            <label>Back Content</label>
            <textarea name="card_back" class="form-control" rows="3" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Create Card</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="url-data" 
     data-topics-url="{% url 'revizo:get_topics' %}"
     data-filter-url="{% url 'revizo:filter_flashcards' %}"
     style="display: none;">
</div>

<div id="initial-flashcards" 
     data-cards="{{ flashcards_json|safe }}" 
     style="display: none;">
</div>

{% endblock %}

{% block scripts %}
<script src="{% static 'revizo/js/flashcards.js' %}"></script>
{% endblock %}
